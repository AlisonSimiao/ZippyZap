services:
  #api:
  #  build:
  #    context: ./../api
  #    dockerfile: Dockerfile
  #    args:
  #      APP_NAME: api
  #  container_name: nest_api
  #  environment:
  #    - DATABASE_URL=postgresql://postgres.tgyyvbbejknsvholpinc:NLpZMVjlLohD2RWG@aws-1-sa-east-1.pooler.supabase.com/postgres?pgbouncer=true
  #    - PORT=8080
  #    - REDIS_HOST=redis-17498.crce207.sa-east-1-2.ec2.redns.redis-cloud.com
  #    - REDIS_PASS=pxSrCrvgRoTfWfcsqupckoYjrYQPkSfu
  #    - REDIS_PORT=17498
  #    - REDIS_USER=default
  #    - JWT_SECRET=ksjbjacbajksbcjkab
  #    - JWT_EXPIRE=8h
  #    - MP_ACCESS_TOKEN='APP_USR-3129267535532433-082920-628114561e1b3c15b7c56e0f822396ce-245147832'
  #  ports:
  #     - "8080:8080"

  # worker:
  #   build:
  #     context: ./../wss
  #     dockerfile: Dockerfile
  #     args:
  #       APP_NAME: worker
  #   container_name: nest_worker
  #   environment:
  #     - NODE_ENV=production
  #     - DATABASE_URL=postgresql://postgres.tgyyvbbejknsvholpinc:NLpZMVjlLohD2RWG@aws-1-sa-east-1.pooler.supabase.com/postgres?pgbouncer=true
  #     - REDIS_HOST=zapi-redis
  #     - REDIS_PASS=
  #     - REDIS_PORT=6379
  #     - REDIS_USER=
  #     - WUZAPI_BASE_URL=http://wuzapi:8080
  #     - WUZAPI_ADMIN_TOKEN=${WUZAPI_ADMIN_TOKEN:-your-secure-admin-token-here}
  #   volumes:
  #     - ./.data/tokens:/app/tokens
  #   depends_on:
  #     - wuzapi
  #     - redis

  wuzapi:
    image: asternic/wuzapi
    container_name: zapi-wuzapi
    ports:
      - "8082:8080"
    environment:
      - WUZAPI_ADMIN_TOKEN=${WUZAPI_ADMIN_TOKEN}
      - WUZAPI_GLOBAL_ENCRYPTION_KEY=${WUZAPI_GLOBAL_ENCRYPTION_KEY}
      - WUZAPI_GLOBAL_HMAC_KEY=${WUZAPI_GLOBAL_HMAC_KEY}
      - DB_USER=${WUZAPI_DB_USER:-wuzapi}
      - DB_PASSWORD=${WUZAPI_DB_PASSWORD:-wuzapi}
      - DB_NAME=${WUZAPI_DB_NAME:-wuzapi}
      - DB_HOST=${WUZAPI_DB_HOST:-zapi-postgres}
      - DB_PORT=${WUZAPI_DB_PORT:-5432}
      - TZ=America/Sao_Paulo
    volumes:
      - ./.data/wuzapi/dbdata:/app/dbdata
      - ./.data/wuzapi/files:/app/files
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:15
    container_name: zapi-postgres
    environment:
      POSTGRES_USER: meuuser
      POSTGRES_PASSWORD: minhasenha
      POSTGRES_DB: zippyzap
    ports:
      - "5432:5432"
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
      - ./init-wuzapi-db.sql:/docker-entrypoint-initdb.d/init-wuzapi-db.sql

  redis:
    image: redis:7-alpine
    container_name: zapi-redis
    ports:
      - "6379:6379"
    volumes:
      - ./.data/redis:/data

  proxy:
    image: nginx:alpine
    container_name: nginx_proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    command: certonly --webroot --webroot-path=/var/www/certbot --email alison.simiao@gmail.com --agree-tos --no-eff-email -d zippy-zap.duckdns.org
