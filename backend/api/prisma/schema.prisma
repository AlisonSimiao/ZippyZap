// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  whatsapp      String         @unique
  password      String
  name          String?
  isActive      Boolean        @default(true)
  webhookUrl    String?
  retentionDays Int            @default(30)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  messages      Message[]
  Plan          Plan           @relation(fields: [planId], references: [id])
  planId        Int            @default(1)
  ApiKeys       ApiKey[]
  payments      Payment[]
  subscriptions Subscription[]
  webhooks      Webhook[]

  @@map("users")
}

enum EStatusApiKey {
  ACTIVE
  REVOKED

  @@map("status_api_key")
}

model ApiKey {
  id         Int           @id @default(autoincrement())
  name       String?       @default(nanoid())
  hash       String        @unique @default(uuid())
  userId     Int           @map("user_id")
  status     EStatusApiKey @default(ACTIVE)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt
  lastUsedAt DateTime      @default(now())
  User       User          @relation(fields: [userId], references: [id])

  @@unique([userId, hash])
  @@map("api_keys")
}

model Plan {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  dailyLimit   Int      @default(0) @db.Integer
  monthlyLimit Int      @default(0) @db.Integer
  price        Decimal  @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User[]

  @@map("plans")
}

model Message {
  id        String        @id @default(cuid())
  userId    Int
  to        String
  content   String
  messageId String? // ID retornado pelo Baileys
  status    MessageStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("messages")
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model Payment {
  id            Int           @id @default(autoincrement())
  userId        Int           @map("user_id")
  planId        Int           @map("plan_id")
  mercadoPagoId String        @unique @map("mercado_pago_id")
  preferenceId  String?       @map("preference_id")
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  paymentType   String?       @map("payment_type")
  paymentMethod String?       @map("payment_method")
  metadata      Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id])
  subscriptions Subscription[]

  @@map("payments")
}

model Subscription {
  id        Int                @id @default(autoincrement())
  userId    Int                @map("user_id")
  planId    Int                @map("plan_id")
  paymentId Int?               @map("payment_id")
  startDate DateTime           @map("start_date")
  endDate   DateTime           @map("end_date")
  status    SubscriptionStatus @default(ACTIVE)
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("subscriptions")
}

model Webhook {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  url       String
  name      String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookEvents WebhookEvent[]
  logs          WebhookLog[]

  @@map("webhooks")
}

model Event {
  id          Int            @id @default(autoincrement())
  name        String
  slug        String         @unique
  description String?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  webhooks    WebhookEvent[]

  @@map("events")
}

model WebhookEvent {
  id        Int      @id @default(autoincrement())
  webhookId Int      @map("webhook_id")
  eventId   Int      @map("event_id")
  active    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([webhookId, eventId])
  @@map("webhook_events")
}

model WebhookLog {
  id        Int      @id @default(autoincrement())
  webhookId Int      @map("webhook_id")
  event     String
  payload   Json
  status    Int // HTTP Status Code
  response  String? // Response body or error message
  duration  Int // Duration in ms
  createdAt DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_logs")
}
